<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Integration &mdash; PDFstream 0.6.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Transformation" href="transformation.html" />
    <link rel="prev" title="Average" href="average.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> PDFstream
          </a>
              <div class="version">
                0.6.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Users Documents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="calibration.html">Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="average.html">Average</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-does-integration-do">What does integration do?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-do-integration">How to do integration?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-simple-integration">A simple integration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-directory">Output directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#background-subtraction">Background subtraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#auto-masking">Auto masking</a></li>
<li class="toctree-l4"><a class="reference internal" href="#histogram-calculation">Histogram Calculation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#visualization">Visualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parallel-computing">Parallel Computing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="transformation.html">Transformation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials1/index.html">Beamline Scientists Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">PDFstream Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../min_versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PDFstream</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Users Documents</a> &raquo;</li>
      <li>Integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials0/integration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="integration">
<h1>Integration<a class="headerlink" href="#integration" title="Permalink to this heading">¶</a></h1>
<section id="what-does-integration-do">
<h2>What does integration do?<a class="headerlink" href="#what-does-integration-do" title="Permalink to this heading">¶</a></h2>
<p>Integration is to calculate XRD data from diffraction image.
There are four steps in PDFstream integration:
background subtraction, auto masking, histogram calculation with corrections, and visualization.</p>
<p>The background subtraction is to subtract the diffraction image from the sample by the diffraction image of the
background multiplied by a scalar which is one in default. The background diffraction image is usually the
diffraction of air and container of the sample. Two images must have the same dimension.</p>
<p>The auto masking is to mask the background subtracted image automatically. In default settings, the pixels at
the margin of the image, the pixels whose intensity is below the low threshold or above the high threshold and
the pixels whose intensity is too far away from the median value of the pixels in a ring will be masked out.
The masked pixles will not be counted in the histogram calculation.</p>
<p>The histogram calculation is to calculate a histogram of intensities on the pixels. The pixels are binned in
rings and the mean value will be calculated for the bins. The rings will be mapped to the momentum transfer value,
two theta value or radius according to users’ settings. The result will be the XRD data and it will be saved
in .chi files.
This step is based on the
<a class="reference external" href="https://pyfai.readthedocs.io/en/latest/api/pyFAI.html#module-pyFAI.azimuthalIntegrator">pyFAI.azimuthalIntegrator</a>.
Before the histogram, polarization correction and other processes will be done according to the settings.</p>
<p>The visualization is to show the masked background subtracted image and the result of the histogram. Users
can tune the visualization settings to achieve their desired effects.</p>
</section>
<section id="how-to-do-integration">
<h2>How to do integration?<a class="headerlink" href="#how-to-do-integration" title="Permalink to this heading">¶</a></h2>
<p>Here shows the python example how to do the integration. Since
there is a one-to-one relation ship between the python function in <cite>pdfstream</cite> and the command line,
the same tasks can be done using the command line.</p>
<p>Import the function to start.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pdfstream.cli</span> <span class="kn">import</span> <span class="n">integrate</span>
</pre></div>
</div>
<section id="a-simple-integration">
<h3>A simple integration<a class="headerlink" href="#a-simple-integration" title="Permalink to this heading">¶</a></h3>
<p>For example, we are going to calculate XRD data I(Q) using diffraction image “sample_diffraction.tiff”.
We have already done the calibration and gotten the .poni file “geometry.poni”.</p>
<p>We run the following line to calculate XRD data I(Q).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>After it finishes, we will find a file “sample_diffraction.chi” in the same folder where we run the script.</p>
<p>If we would like to integrate another image “another_sample_diffraction.tiff” using the same .poni file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="s2">&quot;another_sample_diffraction.tiff&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can add an arbitrary number of image files after the first argument. The configuration for the integration is
all in the key word arguments described in the following sections.</p>
</section>
<section id="output-directory">
<h3>Output directory<a class="headerlink" href="#output-directory" title="Permalink to this heading">¶</a></h3>
<p>If we would like to output the files in a directory called <code class="docutils literal notranslate"><span class="pre">data</span></code>, we can use key <code class="docutils literal notranslate"><span class="pre">output_dir</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;data&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the folder <code class="docutils literal notranslate"><span class="pre">data</span></code> doesn’t exist, it will be created.</p>
</section>
<section id="background-subtraction">
<h3>Background subtraction<a class="headerlink" href="#background-subtraction" title="Permalink to this heading">¶</a></h3>
<p>Continuing with the last example, we would like to subtract the background scattering from the air and the
container of our sample and the scattering is measured and saved in the “background_diffraction.tiff”.
We run the following line. Remember that all the arguments except .poni file and image files muse be key word
arguments.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">bg_img_file</span><span class="o">=</span><span class="s2">&quot;background_diffraction.tiff&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the background image is measured using a 10 times stronger beam intensity, we can use <code class="docutils literal notranslate"><span class="pre">bg_scale</span></code> to scale
the background image.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">bg_img_file</span><span class="o">=</span><span class="s2">&quot;background_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">bg_scale</span><span class="o">=</span><span class="mf">0.1</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="auto-masking">
<h3>Auto masking<a class="headerlink" href="#auto-masking" title="Permalink to this heading">¶</a></h3>
<p>In default, the auto masking is applied using the default setting.</p>
<p>If we would like to tune the setting, we can use the key <code class="docutils literal notranslate"><span class="pre">mask_setting</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">mask_setting</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="s2">&quot;lower_thresh&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="s2">&quot;upper_thresh&quot;</span><span class="p">:</span> <span class="mf">1e5</span><span class="p">,</span>
        <span class="s2">&quot;edge&quot;</span><span class="p">:</span> <span class="mi">50</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If we would like to use our own mask “user_mask.npy” overlapping with the auto generated mask,
we can use the key <code class="docutils literal notranslate"><span class="pre">mask_file</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">mask_file</span><span class="o">=</span><span class="s2">&quot;user_mask.npy&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that <cite>PDFstream</cite> use the <cite>pyFAI</cite> convention of masking. The mask is an array of integers. The 0 pixels are
good and the 1 pixels are bad which will be masked out.</p>
<p>If we don’t want the auto masking, we can set the <code class="docutils literal notranslate"><span class="pre">mask_setting</span></code> to <code class="docutils literal notranslate"><span class="pre">&quot;OFF&quot;</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">mask_file</span><span class="o">=</span><span class="s2">&quot;user_mask.npy&quot;</span>
    <span class="n">mask_setting</span><span class="o">=</span><span class="s2">&quot;OFF&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This will allow us to use our own mask. Also, we can run without any masks using the following line.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">mask_setting</span><span class="o">=</span><span class="s2">&quot;OFF&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="histogram-calculation">
<h3>Histogram Calculation<a class="headerlink" href="#histogram-calculation" title="Permalink to this heading">¶</a></h3>
<p>In default, the histogram calculation is applied using the default setting.</p>
<p>The configuration can be tuned by the key <code class="docutils literal notranslate"><span class="pre">integ_setting</span></code>. An example below shows how to tune the configuration
to calculate a histogram of I(2theta) with 2048 points using the numpy method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">integ_setting</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;npt&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;2th_deg&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;numpy&quot;</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>For details of the configuration, please see
<a class="reference external" href="https://pyfai.readthedocs.io/en/latest/usage/cookbook/integration_with_python.html?highlight=integrate1d#Azimuthal-averaging-using-pyFAI">pyFAI</a></p>
</section>
<section id="visualization">
<h3>Visualization<a class="headerlink" href="#visualization" title="Permalink to this heading">¶</a></h3>
<p>In default, the visualization configuration is applied using the default setting.</p>
<p>We can use the key <code class="docutils literal notranslate"><span class="pre">img_setting</span></code> to tune how the image is shown. The keys are the same as those of
<a class="reference external" href="https://matplotlib.org/3.1.1/api/_as_gen/matplotlib.axes.Axes.matshow.html">matplotlib.axes.Axes.matshow</a>.
An additional key is <code class="docutils literal notranslate"><span class="pre">z_score</span></code>. It determines the maximum and minimum values for the color map. The color
map is determined by vmin = mean - z_score * std, vamx = mean + z_score * std, where mean is the mean value of
the image, std is the standard deviation of the image. If we would like to show image in a large constrast,
we can tune down the <code class="docutils literal notranslate"><span class="pre">z_score</span></code> to 1 for example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">img_setting</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;z_score&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can use the key <code class="docutils literal notranslate"><span class="pre">plot_setting</span></code> to tune how the result of integration is shown. The keys are the same as those
of the <a class="reference external" href="https://matplotlib.org/api/_as_gen/matplotlib.axes.Axes.plot.html">matplotlib.axes.Axes.plot</a>.
For example, we would like to plot a line with green circles.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">plot_setting</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Both of the key <code class="docutils literal notranslate"><span class="pre">img_setting</span></code> and <code class="docutils literal notranslate"><span class="pre">plot_setting</span></code> can be set to <code class="docutils literal notranslate"><span class="pre">OFF</span></code> to skip the visualization steps.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sample_diffraction.tiff&quot;</span><span class="p">,</span>
    <span class="n">img_setting</span><span class="o">=</span><span class="s2">&quot;OFF&quot;</span><span class="p">,</span>
    <span class="n">plot_setting</span><span class="o">=</span><span class="s2">&quot;OFF&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="parallel-computing">
<h3>Parallel Computing<a class="headerlink" href="#parallel-computing" title="Permalink to this heading">¶</a></h3>
<p>The <cite>integrate</cite> supports parallel computing for multiple images.
If we would like to use the parallel computing for the integration for a long list of images, we can use the
key <code class="docutils literal notranslate"><span class="pre">parallel</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">integrate</span><span class="p">(</span>
    <span class="s2">&quot;geometry.poni&quot;</span><span class="p">,</span>
    <span class="n">a_long_list_of_image_files</span><span class="p">,</span>
    <span class="n">img_setting</span><span class="o">=</span><span class="s2">&quot;OFF&quot;</span><span class="p">,</span>
    <span class="n">plot_setting</span><span class="o">=</span><span class="s2">&quot;OFF&quot;</span><span class="p">,</span>
    <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The efficiency depends on how many cores our machine has. It is recommended to turn off the visualization if
there are a large number of images.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="average.html" class="btn btn-neutral float-left" title="Average" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="transformation.html" class="btn btn-neutral float-right" title="Transformation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Songsheng Tao.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>