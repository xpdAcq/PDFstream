<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Processing Server &mdash; PDFstream 0.6.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data Visualization Server" href="xpdvis_server.html" />
    <link rel="prev" title="Replay Analysis" href="replay_analysis.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> PDFstream
          </a>
              <div class="version">
                0.6.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials0/index.html">Users Documents</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Beamline Scientists Documents</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="run_server.html">Run Servers in One Command</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">Configuration of Servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="replay_analysis.html">Replay Analysis</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Data Processing Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#proxy-settings">Proxy Settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#two-modes">Two Modes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#document-mutation">Document Mutation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#start">Start</a></li>
<li class="toctree-l4"><a class="reference internal" href="#descriptor">Descriptor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#event">Event</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stop">Stop</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="xpdvis_server.html">Data Visualization Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="xpdsave_server.html">Data Serialization Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="zmq_proxy.html">ZMQ Proxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="test.html">Test at the beamline</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">PDFstream Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../min_versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PDFstream</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Beamline Scientists Documents</a> &raquo;</li>
      <li>Data Processing Server</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials1/xpd_server.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="data-processing-server">
<h1>Data Processing Server<a class="headerlink" href="#data-processing-server" title="Permalink to this heading">¶</a></h1>
<p>The data processing server received the data stream of raw x-ray scattering data from the proxy server, conduction data reduction on the data, send out the XRD and PDF data back to the proxy server.</p>
<section id="proxy-settings">
<h2>Proxy Settings<a class="headerlink" href="#proxy-settings" title="Permalink to this heading">¶</a></h2>
<p>The inbound and outbound address of the proxy and the data prefix of the input and output data are set in the section below in the configuration file.</p>
<p>This follows the convention from XpdAn, the previous software for the servers at the beamline.</p>
</section>
<section id="two-modes">
<h2>Two Modes<a class="headerlink" href="#two-modes" title="Permalink to this heading">¶</a></h2>
<p>The data reduction has two modes: (1) calibration mode (2) collection mode. The two modes have mostly the same but differs in whether to start a interactive calibration session. Which mode to run is determined the key word <cite>pyfai_calib_kwargs</cite> in the start document. If there is the key word, it is calibration model, other wise it is collection mode.</p>
<p>I will introduce the collection mode as an example. The calibration mode only adds an interactive pyFAI-calib2 session but doesn’t change other operations. In the collection mode, the server conducts several tasks depending on what document it receives and what event stream it is if it receives a event document. These task are described below.</p>
</section>
<section id="document-mutation">
<h2>Document Mutation<a class="headerlink" href="#document-mutation" title="Permalink to this heading">¶</a></h2>
<p>The server only mutates the documents instead creating new ones. Thus, the uid is the same as the input document. Here, I will introduce how it mutates the documents.</p>
<section id="start">
<h3>Start<a class="headerlink" href="#start" title="Permalink to this heading">¶</a></h3>
<p>The server will read some keys in the start document and add two new keys in it. Below are the keys that the server will read and how they will be used.</p>
<ul class="simple">
<li><p>sample_name (required): make the name of the directory and a part of the file names.</p></li>
<li><p>uid (required): make a part of the file names.</p></li>
<li><p>time (required): make a part of the file names.</p></li>
<li><p>composition_str (required): use it to normalize the I(Q) to get the PDF.</p></li>
<li><p>pyfai_calib_kwargs (optional): start a pyFAI-calib2 session if this key appears.</p></li>
<li><p>user_config (optional): use the user configuration to tune the settings.</p></li>
</ul>
<p>Below are the keys that will be added by the server into start document.</p>
<ul class="simple">
<li><p>directory: used to make the directory.</p></li>
<li><p>filename: used as a template to create the file names.</p></li>
</ul>
<p>The data processing server will save the original start document instead of the mutated ones in <cite>yaml</cite> files.</p>
</section>
<section id="descriptor">
<h3>Descriptor<a class="headerlink" href="#descriptor" title="Permalink to this heading">¶</a></h3>
<p>The server doesn’t use any information from the descriptor. It only adds the keys of processed data in the descriptor. These keys all starts with the name of the detector because they are all associated with a detector image. If there are more than one detector there will be more than one set of keys. Here, I will use detector <cite>pe1</cite> as an example name.</p>
<ul class="simple">
<li><p>pe1_mask: the 2D mask binary array, 0 means good pixel and 1 means bad pixels.</p></li>
<li><p>pe1_chi_2theta: the two theta grid for XRD data.</p></li>
<li><p>pe1_chi_Q: the momentum transfer grid for XRD data.</p></li>
<li><p>pe1_chi_I: the XRD intensity data.</p></li>
<li><p>pe1_iq_Q: the momentum transfer grid for I(Q) data of diffpy.pdfgetx.</p></li>
<li><p>pe1_iq_I: the intensity data for I(Q) data of diffpy.pdfgetx.</p></li>
<li><p>pe1_sq_Q: the momentum transfer grid for S(Q) data of diffpy.pdfgetx.</p></li>
<li><p>pe1_sq_I: the intensity data for S(Q) data of diffpy.pdfgetx.</p></li>
<li><p>pe1_fq_Q: the momentum transfer grid for F(Q) data of diffpy.pdfgetx.</p></li>
<li><p>pe1_fq_I: the intensity data for F(Q) data of diffpy.pdfgetx.</p></li>
<li><p>pe1_gr_Q: the momentum transfer grid for PDF data of diffpy.pdfgetx.</p></li>
<li><p>pe1_gr_I: the intensity data for PDF data of diffpy.pdfgetx.</p></li>
<li><p>pe1_chi_argmax: the Q value at the highest peak in PDF.</p></li>
<li><p>pe1_chi_max: the I value at the highest peak in PDF.s</p></li>
<li><p>pe1_gr_argmax: the r value at the highest peak in PDF.</p></li>
<li><p>pe1_gr_max: the G value at the highest peak in PDF.</p></li>
</ul>
</section>
<section id="event">
<h3>Event<a class="headerlink" href="#event" title="Permalink to this heading">¶</a></h3>
<p>The server fills in all the external references with the real data. It then finds the image data in the event document and then map it to a scikitbeam binner, pyFAI integrator. It uses the scikitbeam binner to bin the intensity and throw out the invalid pixels and then gives the data to the pyFAI integrator to integrate the image along the arcs to get the XRD. Then, it uses the PDFGetter to transfer the XRD to PDF.</p>
<p>The server will add these processed data with the keys stated in the previous section. The data is added either a scalar or a numpy array. These keys have been shown in the previous section so I won’t show it again here. In these data, all of the light weight data is saved to disk during the processing. These data includes the XRD data, PDF data, calibration data, and intermediate data S(Q), F(Q).</p>
<p>In the process below, the scikitbeam binner may be a little necessary. Currently, I am working on substitute it with thy pyFAI integrator to accelerate the auto masking.</p>
</section>
<section id="stop">
<h3>Stop<a class="headerlink" href="#stop" title="Permalink to this heading">¶</a></h3>
<p>The server will not mutate the stop document.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="replay_analysis.html" class="btn btn-neutral float-left" title="Replay Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="xpdvis_server.html" class="btn btn-neutral float-right" title="Data Visualization Server" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Songsheng Tao.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>